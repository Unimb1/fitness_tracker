<!-- templates/add_workout_template.html -->
{% extends "base.html" %}

{% block title %}Создать шаблон тренировки - Фитнес Трекер{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Создать шаблон тренировки</h2>
    <form method="POST" id="workout-template-form">
        <div class="form-group">
            <label for="template_name">Название шаблона:</label>
            <input type="text" id="template_name" name="template_name" required placeholder="Например: Тренировка груди">
        </div>

        <div id="exercises-container">
            <div class="exercise-form" data-exercise-index="0">
                <div class="exercise-header">
                    <h4>Упражнение 1</h4>
                    <button type="button" class="btn-small remove-exercise-btn" style="display: none;">✕ Удалить упражнение</button>
                </div>
                
                <div class="form-group">
                    <label>Упражнение:</label>
                    <select name="exercise_type_0" required class="exercise-select">
                        <option value="">Выберите упражнение</option>
                        <optgroup label="Грудь">
                            <option value="Жим лежа">Жим лежа</option>
                            <option value="Сведение рук в кроссовере на грудь">Сведение рук в кроссовере на грудь</option>
                        </optgroup>
                        <optgroup label="Руки">
                            <option value="Разгибания на трицепс с канатной рукоятью в кроссовере">Разгибания на трицепс с канатной рукоятью в кроссовере</option>
                            <option value="Сгибания на бицепс в рычажном тренажере">Сгибания на бицепс в рычажном тренажере</option>
                        </optgroup>
                        <optgroup label="Плечи">
                            <option value="Махи на плечи со свободным весом">Махи на плечи со свободным весом</option>
                            <option value="Отведение плеча в блочном тренажере &quot;reverse fly&quot;">Отведение плеча в блочном тренажере "reverse fly"</option>
                        </optgroup>
                        <optgroup label="Ноги">
                            <option value="Ягодичный мост в рычажном тренажере">Ягодичный мост в рычажном тренажере</option>
                            <option value="Разгибание бедра стоя в кроссовере / рычажном тренажере">Разгибание бедра стоя в кроссовере / рычажном тренажере</option>
                            <option value="Болгарские выпады со свободным весом / в смите">Болгарские выпады со свободным весом / в смите</option>
                            <option value="Отведение бедра сидя в сдвоенном блочном тренажере (большая ягодичная)">Отведение бедра сидя в сдвоенном блочном тренажере (большая ягодичная)</option>
                            <option value="Отведение с наклоном вперед бедра сидя в сдвоенном блочном тренажере (малая и средняя ягодичные)">Отведение с наклоном вперед бедра сидя в сдвоенном блочном тренажере (малая и средняя ягодичные)</option>
                            <option value="Приседание в Смите">Приседание в Смите</option>
                        </optgroup>
                        <optgroup label="Спина">
                            <option value="Вертикальная тяга сидя">Вертикальная тяга сидя</option>
                            <option value="Горизонтальная тяга троссовая в блочном тренажере">Горизонтальная тяга троссовая в блочном тренажере</option>
                            <option value="Экстензия на наклонной скамье">Экстензия на наклонной скамье</option>
                        </optgroup>
                        <optgroup label="Кардио">
                            <option value="Ходьба на дорожке с наклоном 13-14">Ходьба на дорожке с наклоном 13-14</option>
                        </optgroup>
                    </select>
                </div>

                <div class="sets-container" data-exercise-index="0">
                    <div class="set-form" data-set-index="0">
                        <div class="set-header">
                            <h5>Подход 1</h5>
                            <button type="button" class="btn-small remove-set-btn" style="display: none;">✕</button>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Вес (кг):</label>
                                <input type="number" name="weight_0_0" step="0.5" required>
                            </div>
                            <div class="form-group">
                                <label>Повторения:</label>
                                <input type="number" name="reps_0_0" required min="1">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn-secondary add-set-btn" data-exercise-index="0">+ Добавить подход</button>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" id="add-exercise-btn" class="btn-secondary">+ Добавить упражнение</button>
            <button type="submit" class="btn-primary">Сохранить шаблон</button>
        </div>
    </form>

    <div class="abbreviations-info">
        <h3>Пояснения к аббревиатурам:</h3>
        <ul>
            <li><strong>БТ</strong> - Блочный тренажер</li>
            <li><strong>Т</strong> - Тренажер</li>
            <li><strong>РТ</strong> - Рычажный тренажер</li>
        </ul>
    </div>
</div>

<script>

// В обработчике submit формы добавьте:
document.getElementById('workout-template-form').addEventListener('submit', function(e) {
    const form = this;
    const exercises = form.querySelectorAll('.exercise-form');
    
    exercises.forEach((exercise, exerciseIndex) => {
        const exerciseSelect = exercise.querySelector('select[name^="exercise_type_"]');
        const exerciseType = exerciseSelect ? exerciseSelect.value.trim() : '';
        
        if (!exerciseType) {
            // Отключаем все поля пустого упражнения
            const inputs = exercise.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.disabled = true;
            });
        } else {
            // Проверяем подходы
            const sets = exercise.querySelectorAll('.set-form');
            sets.forEach((set, setIndex) => {
                const weightInput = set.querySelector('input[name^="weight_"]');
                const repsInput = set.querySelector('input[name^="reps_"]');
                
                const weight = weightInput ? weightInput.value.trim() : '';
                const reps = repsInput ? repsInput.value.trim() : '';
                
                // Если подход пустой, отключаем его поля
                if (!weight || !reps) {
                    if (weightInput) weightInput.disabled = true;
                    if (repsInput) repsInput.disabled = true;
                } else {
                    // Проверяем, что значения числовые
                    if (isNaN(parseFloat(weight)) || isNaN(parseInt(reps))) {
                        if (weightInput) weightInput.disabled = true;
                        if (repsInput) repsInput.disabled = true;
                    }
                }
            });
        }
    });
});

// Тот же JavaScript код что и в add_workout_session.html
document.addEventListener('DOMContentLoaded', function() {
    let exerciseCount = 1;
    const container = document.getElementById('exercises-container');
    const addExerciseBtn = document.getElementById('add-exercise-btn');
    
    addExerciseBtn.addEventListener('click', function() {
        const newExercise = container.children[0].cloneNode(true);
        exerciseCount++;
        
        newExercise.setAttribute('data-exercise-index', exerciseCount);
        newExercise.querySelector('h4').textContent = `Упражнение ${exerciseCount}`;
        
        updateElementNames(newExercise, exerciseCount);
        
        const setsContainer = newExercise.querySelector('.sets-container');
        setsContainer.setAttribute('data-exercise-index', exerciseCount);
        
        const addSetBtn = newExercise.querySelector('.add-set-btn');
        addSetBtn.setAttribute('data-exercise-index', exerciseCount);
        
        const inputs = newExercise.querySelectorAll('input, select');
        inputs.forEach(input => {
            if (input.tagName === 'INPUT') {
                input.value = '';
            } else if (input.tagName === 'SELECT') {
                input.selectedIndex = 0;
            }
        });
        
        const setForms = newExercise.querySelectorAll('.set-form');
        for (let i = 1; i < setForms.length; i++) {
            setForms[i].remove();
        }
        
        const firstSet = newExercise.querySelector('.set-form');
        firstSet.setAttribute('data-set-index', 0);
        firstSet.querySelector('h5').textContent = 'Подход 1';
        firstSet.querySelector('.remove-set-btn').style.display = 'none';
        
        newExercise.querySelector('.remove-exercise-btn').style.display = 'block';
        
        container.appendChild(newExercise);
    });
    
    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-set-btn')) {
            const exerciseIndex = e.target.getAttribute('data-exercise-index');
            const setsContainer = document.querySelector(`.sets-container[data-exercise-index="${exerciseIndex}"]`);
            const setForms = setsContainer.querySelectorAll('.set-form');
            const setCount = setForms.length;
            
            const newSet = setForms[0].cloneNode(true);
            newSet.setAttribute('data-set-index', setCount);
            newSet.querySelector('h5').textContent = `Подход ${setCount + 1}`;
            
            const inputs = newSet.querySelectorAll('input');
            inputs.forEach(input => {
                const name = input.getAttribute('name').replace(/_(\d+)_(\d+)$/, `_${exerciseIndex}_${setCount}`);
                input.setAttribute('name', name);
                input.value = '';
            });
            
            newSet.querySelector('.remove-set-btn').style.display = 'block';
            
            setsContainer.appendChild(newSet);
        }
    });
    
    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-exercise-btn')) {
            if (container.children.length > 1) {
                e.target.closest('.exercise-form').remove();
                Array.from(container.children).forEach((exercise, index) => {
                    const newIndex = index;
                    exercise.setAttribute('data-exercise-index', newIndex);
                    exercise.querySelector('h4').textContent = `Упражнение ${newIndex + 1}`;
                    
                    updateElementNames(exercise, newIndex);
                    
                    exercise.querySelector('.sets-container').setAttribute('data-exercise-index', newIndex);
                    exercise.querySelector('.add-set-btn').setAttribute('data-exercise-index', newIndex);
                });
                exerciseCount = container.children.length;
            }
        }
    });
    
    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-set-btn')) {
            const setForm = e.target.closest('.set-form');
            const setsContainer = setForm.parentElement;
            const setForms = setsContainer.querySelectorAll('.set-form');
            
            if (setForms.length > 1) {
                setForm.remove();
                Array.from(setsContainer.children).forEach((set, index) => {
                    const newIndex = index;
                    set.setAttribute('data-set-index', newIndex);
                    set.querySelector('h5').textContent = `Подход ${newIndex + 1}`;
                    
                    const exerciseIndex = setsContainer.getAttribute('data-exercise-index');
                    const inputs = set.querySelectorAll('input');
                    inputs.forEach(input => {
                        const name = input.getAttribute('name').replace(/_(\d+)_(\d+)$/, `_${exerciseIndex}_${newIndex}`);
                        input.setAttribute('name', name);
                    });
                });
            }
        }
    });
    
    function updateElementNames(element, newIndex) {
        const inputs = element.querySelectorAll('input, select');
        inputs.forEach(input => {
            const name = input.getAttribute('name').replace(/_(\d+)/, `_${newIndex}`);
            input.setAttribute('name', name);
        });
    }
});
</script>

<style>
.exercise-form {
    background: #f8f8f8;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-radius: 8px;
    border-left: 4px solid #333;
    position: relative;
}

.exercise-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.exercise-header h4 {
    margin: 0;
    color: #333;
    font-size: 1.1rem;
}

.sets-container {
    margin: 1rem 0;
}

.set-form {
    background: white;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-radius: 6px;
    border: 1px solid #ddd;
}

.set-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.set-header h5 {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.remove-exercise-btn, .remove-set-btn {
    background: #ff4444;
    color: white;
    border: none;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
}

.remove-exercise-btn:hover, .remove-set-btn:hover {
    background: #cc0000;
}
</style>
{% endblock %}