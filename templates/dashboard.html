{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –§–∏—Ç–Ω–µ—Å –¢—Ä–µ–∫–µ—Ä{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="header">
        <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
        <div class="header-actions">
            <a href="{{ url_for('add_workout_session') }}" class="btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</a>
            <a href="{{ url_for('analytics') }}" class="btn-secondary">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
            <a href="{{ url_for('add_goal') }}" class="btn-secondary">üéØ –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å</a>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card streak-card" id="streak-card">
            <h3>üî• –¶–µ–ø–æ—á–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
            <div class="stat-number">{{ streak_days }}</div>
            <div class="stat-label">—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–¥—Ä—è–¥</div>
            {% if longest_streak > streak_days %}
            <div class="streak-info">–†–µ–∫–æ—Ä–¥: {{ longest_streak }} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
            {% endif %}
        </div>
        <div class="stat-card">
            <h3>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
            <div class="stat-number">{{ week_workouts_count }}</div>
            <div class="stat-label">—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
        </div>
        <div class="stat-card muscle-group-card">
            <h3>
                –ü–æ—Ö–æ–¥—ã –Ω–∞ 
                <select id="muscle-group-select" class="muscle-group-select">
                    <option value="–ì—Ä—É–¥—å">–≥—Ä—É–¥—å</option>
                    <option value="–†—É–∫–∏">—Ä—É–∫–∏</option>
                    <option value="–Ø–≥–æ–¥–∏—Ü—ã">—è–≥–æ–¥–∏—Ü—ã</option>
                    <option value="–ù–æ–≥–∏">–Ω–æ–≥–∏</option>
                    <option value="–°–ø–∏–Ω–∞">—Å–ø–∏–Ω—É</option>
                </select>
            </h3>
            <div class="stat-number" id="muscle-group-count">{{ muscle_group_data.get('–ì—Ä—É–¥—å', 0) }}</div>
            <div class="stat-label">–∑–∞ –Ω–µ–¥–µ–ª—é</div>
        </div>
        <div class="stat-card">
            <h3>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>
            <div class="stat-number">{{ "%.0f"|format(avg_duration) if avg_duration > 0 else "0" }}</div>
            <div class="stat-label">–º–∏–Ω—É—Ç</div>
        </div>
        <div class="stat-card">
            <h3>–ö–∞–ª–æ—Ä–∏–π –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
            <div class="stat-number">{{ week_calories }}</div>
            <div class="stat-label">–∫–∫–∞–ª</div>
        </div>
        <div class="stat-card">
            <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π</h3>
            <div class="stat-number">{{ active_goals|length }}</div>
            <div class="stat-label">—Ü–µ–ª–µ–π</div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ü–µ–ø–æ—á–∫–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ -->
    <div id="streak-notification" class="notification-card" style="display: none;">
        <div class="notification-content">
            <div class="notification-icon">üí°</div>
            <div class="notification-text">
                <strong>–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ü–µ–ø–æ—á–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:</strong><br>
                ‚Ä¢ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤ —Ü–µ–ø–æ—á–∫–µ, –µ—Å–ª–∏ –º–µ–∂–¥—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏ –Ω–µ –±–æ–ª–µ–µ 2 –¥–Ω–µ–π –æ—Ç–¥—ã—Ö–∞<br>
                ‚Ä¢ –ï—Å–ª–∏ –ø–µ—Ä–µ—Ä—ã–≤ –±–æ–ª–µ–µ 2 –¥–Ω–µ–π - —Ü–µ–ø–æ—á–∫–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è<br>
                ‚Ä¢ –¶–µ–ø–æ—á–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –∞ –Ω–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏
            </div>
            <button class="notification-close" onclick="hideStreakNotification()">√ó</button>
        </div>
    </div>

    <div class="charts-section">
        <h2>–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</h2>
        {% if progress_data and progress_data != '{}' %}
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
        {% else %}
        <p class="no-data">–î–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.</p>
        {% endif %}
    </div>

    {% if active_double_progressions %}
    <div class="progression-section">
        <h2>–î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è</h2>
        <div class="progression-grid">
            {% for plan in active_double_progressions %}
            <div class="progression-card">
                <h4>{{ plan.exercise_type }}</h4>
                <div class="progression-info">
                    <div>–í–µ—Å: {{ plan.current_weight }}–∫–≥</div>
                    <div>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: {{ plan.current_reps }}/{{ plan.max_reps }}</div>
                    <div>–î–∏–∞–ø–∞–∑–æ–Ω: {{ plan.min_reps }}-{{ plan.max_reps }} –ø–æ–≤—Ç.</div>
                </div>
                <div class="progression-progress">
                    {% set progress_pct = ((plan.current_reps - plan.min_reps) / (plan.max_reps - plan.min_reps) * 100) if (plan.max_reps - plan.min_reps) > 0 else 0 %}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ progress_pct }}%;"></div>
                    </div>
                    <small>–ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —É–≤–µ–ª–∏—á–µ–Ω–∏—é –≤–µ—Å–∞: {{ "%.1f"|format(progress_pct) }}%</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if active_progressions %}
    <div class="progression-section">
        <h2>–ü–ª–∞–Ω—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏</h2>
        <div class="progression-grid">
            {% for plan in active_progressions %}
            <div class="progression-card">
                <h4>{{ plan.exercise_type }}</h4>
                <div class="progression-info">
                    <div>–¢–µ–∫—É—â–∏–π: {{ plan.current_weight }}–∫–≥</div>
                    <div>–¶–µ–ª—å: {{ plan.target_weight }}–∫–≥</div>
                    <div>–ü—Ä–∏—Ä–æ—Å—Ç: +{{ plan.weight_increment }}–∫–≥</div>
                </div>
                <div class="progression-progress">
                    {% set progress_pct = (plan.current_weight / plan.target_weight * 100) if plan.target_weight > 0 else 0 %}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ progress_pct }}%;"></div>
                    </div>
                    <small>{{ "%.1f"|format(progress_pct) }}%</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="goals-section">
        <h2>–ú–æ–∏ —Ü–µ–ª–∏</h2>
        {% if active_goals %}
            <div class="goals-grid">
                {% for goal in active_goals %}
                <div class="goal-card {% if goal.is_completed %}completed{% endif %}">
                    <div class="goal-header">
                        <div class="goal-title-wrapper">
                            <h4>{{ goal.exercise_type }}</h4>
                            <span class="goal-deadline">–¥–æ {{ goal.target_date.strftime('%d.%m.%Y') }}</span>
                        </div>
                        <a href="{{ url_for('delete_goal', goal_id=goal.id) }}" class="delete-goal-btn" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å?')">√ó</a>
                    </div>
                    
                    <div class="goal-details">
                        <div class="goal-target">
                            <strong>–¶–µ–ª—å:</strong> {{ goal.target_weight }}–∫–≥ √ó {{ goal.target_reps }}–ø–æ–≤—Ç. √ó {{ goal.target_sets }}–ø–æ–¥—Ö.
                        </div>
                        {% if goal.current_weight > 0 %}
                        <div class="goal-current">
                            <strong>–¢–µ–∫—É—â–∏–π:</strong> {{ goal.current_weight }}–∫–≥ √ó {{ goal.current_reps }}–ø–æ–≤—Ç. √ó {{ goal.current_sets }}–ø–æ–¥—Ö.
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="goal-progress">
                        <div class="progress-text">–ü—Ä–æ–≥—Ä–µ—Å—Å: {{ "%.1f"|format(goal.progress_percentage) }}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ goal.progress_percentage }}%;"></div>
                        </div>
                    </div>
                    
                    <div class="goal-actions">
                        <a href="{{ url_for('update_progress', goal_id=goal.id) }}" class="btn-small">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</a>
                    </div>
                    
                    {% if goal.is_completed %}
                    <div class="goal-completed">üéâ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="no-data">–¶–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç. <a href="{{ url_for('add_goal') }}">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ü–µ–ª—å!</a></p>
        {% endif %}
    </div>

    <div class="workout-sessions">
        <div class="sessions-header">
            <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h2>
            <div class="sessions-controls">
                <div class="control-group">
                    <label for="sessions-limit">–ü–æ–∫–∞–∑–∞—Ç—å:</label>
                    <select id="sessions-limit" class="control-select">
                        <option value="5">5 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</option>
                        <option value="10">10 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</option>
                        <option value="20">20 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</option>
                        <option value="all">–í—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="sessions-sort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                    <select id="sessions-sort" class="control-select">
                        <option value="date-desc">–î–∞—Ç–∞ (–Ω–æ–≤—ã–µ)</option>
                        <option value="date-asc">–î–∞—Ç–∞ (—Å—Ç–∞—Ä—ã–µ)</option>
                        <option value="calories-desc">–ö–∞–ª–æ—Ä–∏–∏ (–±–æ–ª—å—à–µ)</option>
                        <option value="calories-asc">–ö–∞–ª–æ—Ä–∏–∏ (–º–µ–Ω—å—à–µ)</option>
                        <option value="duration-desc">–í—Ä–µ–º—è (–¥–æ–ª—å—à–µ)</option>
                        <option value="duration-asc">–í—Ä–µ–º—è (–∫–æ—Ä–æ—á–µ)</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="sessions-container" class="sessions-list">
            {% if recent_sessions %}
                {% for session in recent_sessions %}
                <div class="workout-session" data-date="{{ session.date.isoformat() }}" data-calories="{{ session.total_calories or 0 }}" data-duration="{{ session.duration_minutes or 0 }}">
                    <div class="session-header">
                        <div class="session-info">
                            <div class="session-name">{{ session.name }}</div>
                            <div class="session-date">{{ session.date.strftime('%d.%m.%Y') }}</div>
                            {% if session.total_calories > 0 %}
                            <div class="session-calories">üî• {{ "%.0f"|format(session.total_calories) }} –∫–∫–∞–ª</div>
                            {% endif %}
                            {% if session.duration_minutes > 0 %}
                            <div class="session-duration">‚è± {{ "%.0f"|format(session.duration_minutes) }} –º–∏–Ω</div>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('delete_workout_session', session_id=session.id) }}" class="delete-session-btn" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')">√ó</a>
                    </div>
                    <div class="session-exercises">
                        {% for exercise in session.exercises %}
                        <div class="session-exercise">
                            <div class="exercise-info">
                                <span class="exercise-name">{{ exercise.exercise_type }}</span>
                            </div>
                            <div class="exercise-sets">
                                {% for set_data in exercise.get_sets_data() %}
                                <div class="exercise-set">
                                    <span class="set-number">–ü–æ–¥—Ö–æ–¥ {{ set_data.set_number }}</span>
                                    <span class="set-weight">{{ set_data.weight }} –∫–≥</span>
                                    <span class="set-reps">{{ set_data.reps }} –ø–æ–≤—Ç.</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="no-data">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. <a href="{{ url_for('add_workout_session') }}">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!</a></p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const progressData = {{ progress_data | safe }};
    const ctx = document.getElementById('progressChart');
    
    if (!ctx || !progressData || Object.keys(progressData).length === 0) {
        return;
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞—Ç—ã
    const allDates = new Set();
    for (const [exercise, data] of Object.entries(progressData)) {
        if (data.dates && data.dates.length > 0) {
            data.dates.forEach(date => allDates.add(date));
        }
    }
    
    const sortedDates = Array.from(allDates).sort();
    
    // –°–æ–∑–¥–∞–µ–º datasets –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
    const datasets = [];
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
    
    let colorIndex = 0;
    for (const [exercise, data] of Object.entries(progressData)) {
        if (data.dates && data.dates.length > 0) {
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç
            const weights = [];
            const dateMap = {};
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–∞—Ç –∫ –≤–µ—Å–∞–º
            for (let i = 0; i < data.dates.length; i++) {
                dateMap[data.dates[i]] = data.weights[i];
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –≤–µ—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç
            sortedDates.forEach(date => {
                weights.push(dateMap[date] || null);
            });
            
            datasets.push({
                label: exercise,
                data: weights,
                borderColor: colors[colorIndex % colors.length],
                backgroundColor: colors[colorIndex % colors.length] + '40',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
            colorIndex++;
        }
    }
    
    if (datasets.length > 0 && sortedDates.length > 0) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedDates.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                }),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–í–µ—Å (–∫–≥)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–î–∞—Ç–∞'
                        }
                    }
                }
            }
        });
    }

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ü–µ–ø–æ—á–∫–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    const streakCard = document.getElementById('streak-card');
    if (streakCard) {
        streakCard.addEventListener('mouseenter', function() {
            showStreakNotification();
        });

        streakCard.addEventListener('mouseleave', function(e) {
            // –ù–µ —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å
            setTimeout(() => {
                if (!document.querySelector('#streak-notification:hover')) {
                    hideStreakNotification();
                }
            }, 300);
        });
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–∞–∫–∂–µ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∑–∞ –µ–≥–æ –ø—Ä–µ–¥–µ–ª—ã
    const notification = document.getElementById('streak-notification');
    if (notification) {
        notification.addEventListener('mouseleave', function() {
            hideStreakNotification();
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã –º—ã—à—Ü
    const muscleGroupSelect = document.getElementById('muscle-group-select');
    const muscleGroupCount = document.getElementById('muscle-group-count');

    if (muscleGroupSelect && muscleGroupCount) {
        // –î–∞–Ω–Ω—ã–µ –ø–æ –≥—Ä—É–ø–ø–∞–º –º—ã—à—Ü
        const muscleGroupData = {
            '–ì—Ä—É–¥—å': {{ muscle_group_data.get('–ì—Ä—É–¥—å', 0) }},
            '–†—É–∫–∏': {{ muscle_group_data.get('–†—É–∫–∏', 0) }},
            '–Ø–≥–æ–¥–∏—Ü—ã': {{ muscle_group_data.get('–Ø–≥–æ–¥–∏—Ü—ã', 0) }},
            '–ù–æ–≥–∏': {{ muscle_group_data.get('–ù–æ–≥–∏', 0) }},
            '–°–ø–∏–Ω–∞': {{ muscle_group_data.get('–°–ø–∏–Ω–∞', 0) }}
        };

        muscleGroupSelect.addEventListener('change', function() {
            // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
            muscleGroupCount.style.animation = 'pulse 0.3s ease-out';
            setTimeout(() => {
                muscleGroupCount.style.animation = '';
            }, 300);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            muscleGroupCount.textContent = muscleGroupData[this.value];
        });
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    const sessionsLimit = document.getElementById('sessions-limit');
    const sessionsSort = document.getElementById('sessions-sort');
    const sessionsContainer = document.getElementById('sessions-container');

    if (sessionsLimit && sessionsSort && sessionsContainer) {
        let currentSessions = Array.from(sessionsContainer.querySelectorAll('.workout-session'));

        function updateSessionsDisplay() {
            const limit = sessionsLimit.value === 'all' ? currentSessions.length : parseInt(sessionsLimit.value);
            const sortBy = sessionsSort.value;

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            currentSessions.sort((a, b) => {
                switch (sortBy) {
                    case 'date-desc':
                        return new Date(b.dataset.date) - new Date(a.dataset.date);
                    case 'date-asc':
                        return new Date(a.dataset.date) - new Date(b.dataset.date);
                    case 'calories-desc':
                        return parseFloat(b.dataset.calories) - parseFloat(a.dataset.calories);
                    case 'calories-asc':
                        return parseFloat(a.dataset.calories) - parseFloat(b.dataset.calories);
                    case 'duration-desc':
                        return parseFloat(b.dataset.duration) - parseFloat(a.dataset.duration);
                    case 'duration-asc':
                        return parseFloat(a.dataset.duration) - parseFloat(b.dataset.duration);
                    default:
                        return 0;
                }
            });

            // –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            sessionsContainer.innerHTML = '';

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            currentSessions.slice(0, limit).forEach((session, index) => {
                setTimeout(() => {
                    sessionsContainer.appendChild(session);
                    session.style.animation = 'slideInUp 0.5s ease-out';
                }, index * 100);
            });

            // –ï—Å–ª–∏ –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
            if (currentSessions.length === 0) {
                sessionsContainer.innerHTML = '<p class="no-data">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. <a href="{{ url_for("add_workout_session") }}">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!</a></p>';
            }
        }

        sessionsLimit.addEventListener('change', updateSessionsDisplay);
        sessionsSort.addEventListener('change', updateSessionsDisplay);
    }
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showStreakNotification() {
    const notification = document.getElementById('streak-notification');
    if (notification) {
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateY(0)';
        }, 10);
    }
}

function hideStreakNotification() {
    const notification = document.getElementById('streak-notification');
    if (notification) {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 300);
    }
}

// –ê–Ω–∏–º–∞—Ü–∏–∏
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .stat-card {
        position: relative;
        text-align: center;
        padding: 1.5rem 1rem;
    }

    .stat-card h3 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-primary);
        line-height: 1.4;
        min-height: 2.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 0.5rem;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0.5rem 0;
        line-height: 1;
        min-height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
    }

    .streak-card {
        cursor: help;
    }

    .notification-card {
        position: relative;
        background: linear-gradient(135deg, #1e293b, #334155);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1rem 0;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100;
    }

    .notification-content {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        position: relative;
    }

    .notification-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
        margin-top: 0.2rem;
    }

    .notification-text {
        flex: 1;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .notification-text strong {
        color: #fbbf24;
        margin-bottom: 0.5rem;
        display: block;
    }

    .notification-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s ease;
    }

    .notification-close:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .muscle-group-select {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 4px 8px;
        background: white;
        font-size: 0.9rem;
        font-weight: 600;
        color: #374151;
        cursor: pointer;
        transition: all 0.3s ease;
        outline: none;
        min-width: 100px;
        text-align: center;
        margin-top: 0.2rem;
    }

    .muscle-group-select:hover {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .muscle-group-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .sessions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .sessions-controls {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .control-group label {
        font-weight: 500;
        color: var(--text-secondary);
        white-space: nowrap;
    }

    .control-select {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 6px 12px;
        background: white;
        font-size: 0.9rem;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.3s ease;
        outline: none;
        min-width: 140px;
    }

    .control-select:hover {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .control-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .workout-session {
        animation: slideInUp 0.5s ease-out;
    }

    @media (max-width: 768px) {
        .sessions-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .sessions-controls {
            justify-content: space-between;
        }
        
        .control-group {
            flex: 1;
            justify-content: space-between;
        }
        
        .control-select {
            min-width: 120px;
        }
        
        .stat-card h3 {
            font-size: 0.9rem;
            min-height: 2.5rem;
        }
        
        .stat-number {
            font-size: 2rem;
        }
        
        .notification-card {
            margin: 0.5rem 0;
            padding: 1rem;
        }
        
        .notification-content {
            gap: 0.75rem;
        }
        
        .notification-text {
            font-size: 0.85rem;
        }
    }

    @media (max-width: 480px) {
        .sessions-controls {
            flex-direction: column;
            gap: 1rem;
        }
        
        .control-group {
            justify-content: space-between;
        }
        
        .muscle-group-select {
            min-width: 80px;
            font-size: 0.8rem;
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}