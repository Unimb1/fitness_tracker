{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –§–∏—Ç–Ω–µ—Å –¢—Ä–µ–∫–µ—Ä{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="header">
        <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
        <div class="header-actions">
            <a href="{{ url_for('add_workout_session') }}" class="btn-primary">
                <span class="btn-text-full">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</span>
                <span class="btn-text-short">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω.</span>
            </a>
            <a href="{{ url_for('analytics') }}" class="btn-secondary">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
            <a href="{{ url_for('add_goal') }}" class="btn-secondary">üéØ –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å</a>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card streak-card" id="streak-card">
            <h3>üî• –¶–µ–ø–æ—á–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
            <div class="stat-number">{{ streak_days }}</div>
            <div class="stat-label">—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–¥—Ä—è–¥</div>
            {% if longest_streak > streak_days %}
            <div class="streak-info">–†–µ–∫–æ—Ä–¥: {{ longest_streak }} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
            {% endif %}
        </div>
        <div class="stat-card">
            <h3>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
            <div class="stat-number">{{ week_workouts_count }}</div>
            <div class="stat-label">—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
        </div>
        <div class="stat-card muscle-group-card">
            <h3>–ü–æ–¥—Ö–æ–¥—ã –Ω–∞ –≥—Ä—É–ø–ø—É</h3>
            <div class="stat-number" id="muscle-group-count">{{ muscle_group_data.get('–ì—Ä—É–¥—å', 0) }}</div>
            <div class="stat-label">–∑–∞ –Ω–µ–¥–µ–ª—é</div>
            <select id="muscle-group-select" class="muscle-group-select">
                <option value="–ì—Ä—É–¥—å">–ì—Ä—É–¥—å</option>
                <option value="–†—É–∫–∏">–†—É–∫–∏</option>
                <option value="–ü–ª–µ—á–∏">–ü–ª–µ—á–∏</option>
                <option value="–Ø–≥–æ–¥–∏—Ü—ã">–Ø–≥–æ–¥–∏—Ü—ã</option>
                <option value="–ù–æ–≥–∏">–ù–æ–≥–∏</option>
                <option value="–°–ø–∏–Ω–∞">–°–ø–∏–Ω–∞</option>
            </select>
        </div>
        <div class="stat-card">
            <h3>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>
            <div class="stat-number">{{ "%.0f"|format(avg_duration) if avg_duration > 0 else "0" }}</div>
            <div class="stat-label">–º–∏–Ω—É—Ç</div>
        </div>
        <div class="stat-card">
            <h3>–ö–∞–ª–æ—Ä–∏–π –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
            <div class="stat-number">{{ week_calories }}</div>
            <div class="stat-label">–∫–∫–∞–ª</div>
        </div>
        <div class="stat-card">
            <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π</h3>
            <div class="stat-number">{{ active_goals|length }}</div>
            <div class="stat-label">—Ü–µ–ª–µ–π</div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ü–µ–ø–æ—á–∫–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ -->
    <div id="streak-notification" class="notification-card" style="display: none;">
        <div class="notification-content">
            <div class="notification-icon">üí°</div>
            <div class="notification-text">
                <strong>–ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ü–µ–ø–æ—á–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:</strong><br>
                ‚Ä¢ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤ —Ü–µ–ø–æ—á–∫–µ, –µ—Å–ª–∏ –º–µ–∂–¥—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏ –Ω–µ –±–æ–ª–µ–µ 2 –¥–Ω–µ–π –æ—Ç–¥—ã—Ö–∞<br>
                ‚Ä¢ –ï—Å–ª–∏ –ø–µ—Ä–µ—Ä—ã–≤ –±–æ–ª–µ–µ 2 –¥–Ω–µ–π - —Ü–µ–ø–æ—á–∫–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è<br>
                ‚Ä¢ –¶–µ–ø–æ—á–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –∞ –Ω–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –¥–Ω–∏
            </div>
            <button class="notification-close" onclick="hideStreakNotification()">√ó</button>
        </div>
    </div>

    <div class="charts-section">
        <h2>–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</h2>
        {% if progress_data and progress_data != '{}' %}
        <div class="chart-filters">
            <div class="chart-filters-row">
                <div class="filter-group">
                    <select id="chart-date-range" class="chart-filter" title="–ü–µ—Ä–∏–æ–¥">
                        <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                        <option value="14">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π</option>
                        <option value="30" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                        <option value="60">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 60 –¥–Ω–µ–π</option>
                        <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π</option>
                        <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
                        <option value="custom">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="chart-exercise" class="chart-filter" title="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">
                        <option value="all">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="chart-metric" class="chart-filter" title="–ú–µ—Ç—Ä–∏–∫–∞">
                        <option value="avg_weight" selected>–°—Ä–µ–¥–Ω–∏–π –≤–µ—Å</option>
                        <option value="avg_reps">–°—Ä–µ–¥–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</option>
                        <option value="volume">–¢–æ–Ω–Ω–∞–∂</option>
                        <option value="max_weight">–ú–∞–∫—Å. –≤–µ—Å</option>
                    </select>
                </div>
            </div>
            <div class="chart-filters-row" id="custom-date-range-row" style="display: none;">
                <div class="filter-group">
                    <input type="date" id="chart-date-from" class="chart-filter" title="–°">
                </div>
                <div class="filter-group">
                    <input type="date" id="chart-date-to" class="chart-filter" title="–ü–æ">
                </div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
        {% else %}
        <p class="no-data">–î–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.</p>
        {% endif %}
    </div>

    {% if active_double_progressions %}
    <div class="progression-section">
        <h2>–î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è</h2>
        <div class="progression-grid">
            {% for plan in active_double_progressions %}
            <div class="progression-card">
                <h4>{{ plan.exercise_type }}</h4>
                <div class="progression-info">
                    <div>–í–µ—Å: {{ plan.current_weight }}–∫–≥</div>
                    <div>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: {{ plan.current_reps }}/{{ plan.max_reps }}</div>
                    <div>–î–∏–∞–ø–∞–∑–æ–Ω: {{ plan.min_reps }}-{{ plan.max_reps }} –ø–æ–≤—Ç.</div>
                </div>
                <div class="progression-progress">
                    {% set progress_pct = ((plan.current_reps - plan.min_reps) / (plan.max_reps - plan.min_reps) * 100) if (plan.max_reps - plan.min_reps) > 0 else 0 %}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ progress_pct }}%;"></div>
                    </div>
                    <small>–ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —É–≤–µ–ª–∏—á–µ–Ω–∏—é –≤–µ—Å–∞: {{ "%.1f"|format(progress_pct) }}%</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if active_progressions %}
    <div class="progression-section">
        <h2>–ü–ª–∞–Ω—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏</h2>
        <div class="progression-grid">
            {% for plan in active_progressions %}
            <div class="progression-card">
                <h4>{{ plan.exercise_type }}</h4>
                <div class="progression-info">
                    <div>–¢–µ–∫—É—â–∏–π: {{ plan.current_weight }}–∫–≥</div>
                    <div>–¶–µ–ª—å: {{ plan.target_weight }}–∫–≥</div>
                    <div>–ü—Ä–∏—Ä–æ—Å—Ç: +{{ plan.weight_increment }}–∫–≥</div>
                </div>
                <div class="progression-progress">
                    {% set progress_pct = (plan.current_weight / plan.target_weight * 100) if plan.target_weight > 0 else 0 %}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ progress_pct }}%;"></div>
                    </div>
                    <small>{{ "%.1f"|format(progress_pct) }}%</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="goals-section">
        <h2>–ú–æ–∏ —Ü–µ–ª–∏</h2>
        {% if active_goals %}
            <div class="goals-grid">
                {% for goal in active_goals %}
                <div class="goal-card-wrapper">
                <div class="goal-card {% if goal.is_completed %}completed{% endif %}">
                    <div class="goal-header">
                        <div class="goal-title-wrapper">
                            <h4>{{ goal.exercise_type }}</h4>
                            <span class="goal-deadline">–¥–æ {{ goal.target_date.strftime('%d.%m.%Y') }}</span>
                        </div>
                        <a href="{{ url_for('delete_goal', goal_id=goal.id) }}" class="delete-goal-btn" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å?')">√ó</a>
                    </div>
                    
                    <div class="goal-details">
                        <div class="goal-target">
                            <strong>–¶–µ–ª—å:</strong> {{ goal.target_weight }}–∫–≥ √ó {{ goal.target_reps }}–ø–æ–≤—Ç. √ó {{ goal.target_sets }}–ø–æ–¥—Ö.
                        </div>
                        {% if goal.current_weight > 0 %}
                        <div class="goal-current">
                            <strong>–¢–µ–∫—É—â–∏–π:</strong> {{ goal.current_weight }}–∫–≥ √ó {{ goal.current_reps }}–ø–æ–≤—Ç. √ó {{ goal.current_sets }}–ø–æ–¥—Ö.
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="goal-progress">
                        <div class="progress-text">–ü—Ä–æ–≥—Ä–µ—Å—Å: {{ "%.1f"|format(goal.progress_percentage) }}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ goal.progress_percentage }}%;"></div>
                        </div>
                    </div>
                    
                    <div class="goal-actions">
                        <a href="{{ url_for('update_progress', goal_id=goal.id) }}" class="btn-small">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</a>
                    </div>
                    
                    {% if goal.is_completed %}
                    <div class="goal-completed">üéâ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!</div>
                    {% endif %}
                </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="no-data">–¶–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç. <a href="{{ url_for('add_goal') }}">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ü–µ–ª—å!</a></p>
        {% endif %}
    </div>

    <div class="workout-sessions">
        <div class="sessions-header">
            <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h2>
            <div class="sessions-controls">
                <div class="control-group">
                    <span class="control-label">–ü–æ—Å–ª–µ–¥–Ω–∏–µ:</span>
                    <select id="sessions-limit" class="control-select" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫">
                        <option value="5">5 —Ç—Ä–µ–Ω.</option>
                        <option value="10">10 —Ç—Ä–µ–Ω.</option>
                        <option value="20">20 —Ç—Ä–µ–Ω.</option>
                        <option value="all">–í—Å–µ —Ç—Ä–µ–Ω.</option>
                    </select>
                </div>
                <div class="control-group">
                    <span class="control-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</span>
                    <select id="sessions-sort" class="control-select" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞">
                        <option value="date-desc">–î–∞—Ç–∞ (–Ω–æ–≤—ã–µ)</option>
                        <option value="date-asc">–î–∞—Ç–∞ (—Å—Ç–∞—Ä—ã–µ)</option>
                        <option value="calories-desc">–ö–∞–ª–æ—Ä–∏–∏ (–±–æ–ª—å—à–µ)</option>
                        <option value="calories-asc">–ö–∞–ª–æ—Ä–∏–∏ (–º–µ–Ω—å—à–µ)</option>
                        <option value="duration-desc">–í—Ä–µ–º—è (–¥–æ–ª—å—à–µ)</option>
                        <option value="duration-asc">–í—Ä–µ–º—è (–∫–æ—Ä–æ—á–µ)</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="sessions-container" class="sessions-list">
            {% if recent_sessions %}
                {% for session in recent_sessions %}
                <div class="workout-session-wrapper">
                <div class="workout-session" data-date="{{ session.date.isoformat() }}" data-calories="{{ session.total_calories or 0 }}" data-duration="{{ session.duration_minutes or 0 }}">
                    <div class="session-header">
                        <div class="session-info">
                            <div class="session-name">{{ session.name }}</div>
                            <div class="session-date">{{ session.date.strftime('%d.%m.%Y') }}</div>
                            {% if session.total_calories > 0 %}
                            <div class="session-calories">üî• {{ "%.0f"|format(session.total_calories) }} –∫–∫–∞–ª</div>
                            {% endif %}
                            {% if session.duration_minutes > 0 %}
                            <div class="session-duration">‚è± {{ "%.0f"|format(session.duration_minutes) }} –º–∏–Ω</div>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('delete_workout_session', session_id=session.id) }}" class="delete-session-btn" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')">√ó</a>
                    </div>
                    <div class="session-exercises">
                        {% for exercise in session.exercises %}
                        <div class="session-exercise">
                            <div class="exercise-info">
                                <span class="exercise-name">{{ exercise.exercise_type }}</span>
                            </div>
                            <div class="exercise-sets">
                                {% for set_data in exercise.get_sets_data() %}
                                <div class="exercise-set">
                                    <span class="set-number">–ü–æ–¥—Ö–æ–¥ {{ set_data.set_number }}</span>
                                    <span class="set-weight">{{ set_data.weight }} –∫–≥</span>
                                    <span class="set-reps">{{ set_data.reps }} –ø–æ–≤—Ç.</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="no-data">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. <a href="{{ url_for('add_workout_session') }}">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!</a></p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const progressData = {{ progress_data | safe }};
    const ctx = document.getElementById('progressChart');
    
    if (!ctx || !progressData || Object.keys(progressData).length === 0) {
        return;
    }
    
    let chart = null;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
    const exerciseSelect = document.getElementById('chart-exercise');
    if (exerciseSelect) {
        const exercises = Object.keys(progressData);
        exercises.forEach(exercise => {
            const option = document.createElement('option');
            option.value = exercise;
            option.textContent = exercise;
            exerciseSelect.appendChild(option);
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫–∏
    function getMetricValue(data, metric, dateIndex) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–¥—Ö–æ–¥–∞–º
        if (data.sets_data && data.sets_data[dateIndex] && Array.isArray(data.sets_data[dateIndex])) {
            const sets = data.sets_data[dateIndex];
            
            switch(metric) {
                case 'avg_weight':
                    // –°—Ä–µ–¥–Ω–∏–π –≤–µ—Å = —Å—É–º–º–∞ –≤–µ—Å–æ–≤ –ø–æ –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥–∞–º / –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤
                    let totalWeight = 0;
                    let validSets = 0;
                    sets.forEach(set => {
                        const weight = parseFloat(set.weight);
                        if (weight && weight > 0) {
                            totalWeight += weight;
                            validSets++;
                        }
                    });
                    return validSets > 0 ? totalWeight / validSets : null;
                    
                case 'avg_reps':
                    // –°—Ä–µ–¥–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è = —Å—É–º–º–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –ø–æ –≤—Å–µ–º –ø–æ–¥—Ö–æ–¥–∞–º / –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤
                    let totalReps = 0;
                    let validRepSets = 0;
                    sets.forEach(set => {
                        const reps = parseInt(set.reps);
                        if (reps && reps > 0) {
                            totalReps += reps;
                            validRepSets++;
                        }
                    });
                    return validRepSets > 0 ? totalReps / validRepSets : null;
                    
                case 'volume':
                    // –¢–æ–Ω–Ω–∞–∂ = —Å—É–º–º–∞ (–≤–µ—Å √ó –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è) –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ–¥—Ö–æ–¥—É
                    let totalVolume = 0;
                    sets.forEach(set => {
                        const weight = parseFloat(set.weight) || 0;
                        const reps = parseInt(set.reps) || 0;
                        totalVolume += weight * reps;
                    });
                    return totalVolume > 0 ? totalVolume : null;
                    
                case 'max_weight':
                    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –ø–æ–¥—Ö–æ–¥–æ–≤
                    let maxWeight = 0;
                    sets.forEach(set => {
                        const weight = parseFloat(set.weight) || 0;
                        if (weight > maxWeight) {
                            maxWeight = weight;
                        }
                    });
                    return maxWeight > 0 ? maxWeight : null;
                    
                default:
                    return null;
            }
        }
        
        // Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ sets_data –Ω–µ—Ç
        switch(metric) {
            case 'avg_weight':
                if (data.weights && data.weights[dateIndex] !== undefined) {
                    return data.weights[dateIndex];
                }
                return null;
            case 'avg_reps':
                if (data.reps && data.reps[dateIndex] !== undefined) {
                    return data.reps[dateIndex];
                }
                return null;
            case 'volume':
                if (data.weights && data.reps && data.weights[dateIndex] !== undefined && data.reps[dateIndex] !== undefined) {
                    const weight = parseFloat(data.weights[dateIndex]) || 0;
                    const reps = parseFloat(data.reps[dateIndex]) || 0;
                    const sets = parseFloat(data.sets_count && data.sets_count[dateIndex]) || 1;
                    return (weight * reps * sets) > 0 ? (weight * reps * sets) : null;
                }
                return null;
            case 'max_weight':
                if (data.max_weight && data.max_weight[dateIndex] !== undefined) {
                    return data.max_weight[dateIndex];
                }
                if (data.weights && data.weights[dateIndex] !== undefined) {
                    return data.weights[dateIndex];
                }
                return null;
            default:
                return null;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –º–µ—Ç—Ä–∏–∫–∏
    function getMetricLabel(metric) {
        switch(metric) {
            case 'avg_weight': return '–í–µ—Å (–∫–≥)';
            case 'avg_reps': return '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è';
            case 'volume': return '–¢–æ–Ω–Ω–∞–∂ (–∫–≥)';
            case 'max_weight': return '–í–µ—Å (–∫–≥)';
            default: return '–í–µ—Å (–∫–≥)';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    function updateChart() {
        const dateRange = document.getElementById('chart-date-range')?.value || '30';
        const selectedExercise = document.getElementById('chart-exercise')?.value || 'all';
        const metric = document.getElementById('chart-metric')?.value || 'avg_weight';
        const dateFrom = document.getElementById('chart-date-from')?.value;
        const dateTo = document.getElementById('chart-date-to')?.value;
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–µ
        let startDate = null;
        let endDate = null;
        
        if (dateRange === 'custom' && dateFrom && dateTo) {
            startDate = new Date(dateFrom);
            endDate = new Date(dateTo);
            endDate.setHours(23, 59, 59, 999); // –ö–æ–Ω–µ—Ü –¥–Ω—è
        } else if (dateRange === 'all') {
            startDate = null;
            endDate = null;
        } else if (dateRange !== 'custom') {
            const now = new Date();
            startDate = new Date(now.getTime() - parseInt(dateRange) * 24 * 60 * 60 * 1000);
            endDate = now;
        }
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞—Ç—ã —Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞
        const allDates = new Set();
        const exercisesToShow = selectedExercise === 'all' ? Object.keys(progressData) : [selectedExercise];
        
        exercisesToShow.forEach(exercise => {
            if (progressData[exercise] && progressData[exercise].dates) {
                progressData[exercise].dates.forEach((date, index) => {
                    const dateObj = new Date(date);
                    if ((!startDate || dateObj >= startDate) && (!endDate || dateObj <= endDate)) {
                        allDates.add(date);
                    }
                });
            }
        });
        
        const sortedDates = Array.from(allDates).sort();
        
        // –°–æ–∑–¥–∞–µ–º datasets
        const datasets = [];
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
        let colorIndex = 0;
        
        exercisesToShow.forEach(exercise => {
            const data = progressData[exercise];
            if (!data || !data.dates || data.dates.length === 0) return;
            
            const values = [];
            const dateMap = {};
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–∞—Ç –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º
            for (let i = 0; i < data.dates.length; i++) {
                const dateObj = new Date(data.dates[i]);
                if ((!startDate || dateObj >= startDate) && (!endDate || dateObj <= endDate)) {
                    dateMap[data.dates[i]] = getMetricValue(data, metric, i);
                }
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö –¥–∞—Ç
            sortedDates.forEach(date => {
                values.push(dateMap[date] || null);
            });
            
            datasets.push({
                label: exercise,
                data: values,
                borderColor: colors[colorIndex % colors.length],
                backgroundColor: colors[colorIndex % colors.length] + '40',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
            colorIndex++;
        });
        
        if (chart) {
            chart.destroy();
        }
        
        if (datasets.length > 0 && sortedDates.length > 0) {
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: selectedExercise === 'all',
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 8,
                                font: {
                                    size: 11
                                },
                                usePointStyle: true
                            }
                        },
                        title: {
                            display: true,
                            text: `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${getMetricLabel(metric)}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            padding: 12,
                            titleFont: {
                                size: 13,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 12
                            },
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y;
                                    if (value !== null) {
                                        if (metric === 'volume') {
                                            label += value.toFixed(0) + ' –∫–≥';
                                        } else if (metric === 'avg_weight' || metric === 'max_weight') {
                                            label += value.toFixed(1) + ' –∫–≥';
                                        } else {
                                            label += value.toFixed(1);
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: getMetricLabel(metric),
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 10
                                }
                            },
                            ticks: {
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    if (metric === 'volume') {
                                        return value.toFixed(0) + ' –∫–≥';
                                    } else if (metric === 'avg_weight' || metric === 'max_weight') {
                                        return value.toFixed(1) + ' –∫–≥';
                                    }
                                    return value.toFixed(1);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.08)',
                                lineWidth: 1
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '–î–∞—Ç–∞',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10
                                }
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 4,
                            hoverRadius: 6,
                            borderWidth: 2
                        },
                        line: {
                            tension: 0.4,
                            borderWidth: 2,
                            fill: false
                        }
                    }
                }
            });
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const dateRangeSelect = document.getElementById('chart-date-range');
    const customDateRow = document.getElementById('custom-date-range-row');
    
    dateRangeSelect?.addEventListener('change', function() {
        if (this.value === 'custom') {
            customDateRow.style.display = 'flex';
        } else {
            customDateRow.style.display = 'none';
        }
        updateChart();
    });
    
    document.getElementById('chart-date-from')?.addEventListener('change', updateChart);
    document.getElementById('chart-date-to')?.addEventListener('change', updateChart);
    document.getElementById('chart-exercise')?.addEventListener('change', updateChart);
    document.getElementById('chart-metric')?.addEventListener('change', updateChart);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    updateChart();

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ü–µ–ø–æ—á–∫–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    const streakCard = document.getElementById('streak-card');
    if (streakCard) {
        streakCard.addEventListener('mouseenter', function() {
            showStreakNotification();
        });

        streakCard.addEventListener('mouseleave', function(e) {
            // –ù–µ —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å
            setTimeout(() => {
                if (!document.querySelector('#streak-notification:hover')) {
                    hideStreakNotification();
                }
            }, 300);
        });
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–∞–∫–∂–µ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∑–∞ –µ–≥–æ –ø—Ä–µ–¥–µ–ª—ã
    const notification = document.getElementById('streak-notification');
    if (notification) {
        notification.addEventListener('mouseleave', function() {
            hideStreakNotification();
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã –º—ã—à—Ü
    const muscleGroupSelect = document.getElementById('muscle-group-select');
    const muscleGroupCount = document.getElementById('muscle-group-count');

    if (muscleGroupSelect && muscleGroupCount) {
        // –î–∞–Ω–Ω—ã–µ –ø–æ –≥—Ä—É–ø–ø–∞–º –º—ã—à—Ü
        const muscleGroupData = {
            '–ì—Ä—É–¥—å': {{ muscle_group_data.get('–ì—Ä—É–¥—å', 0) }},
            '–†—É–∫–∏': {{ muscle_group_data.get('–†—É–∫–∏', 0) }},
            '–ü–ª–µ—á–∏': {{ muscle_group_data.get('–ü–ª–µ—á–∏', 0) }},
            '–Ø–≥–æ–¥–∏—Ü—ã': {{ muscle_group_data.get('–Ø–≥–æ–¥–∏—Ü—ã', 0) }},
            '–ù–æ–≥–∏': {{ muscle_group_data.get('–ù–æ–≥–∏', 0) }},
            '–°–ø–∏–Ω–∞': {{ muscle_group_data.get('–°–ø–∏–Ω–∞', 0) }}
        };

        muscleGroupSelect.addEventListener('change', function() {
            // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
            muscleGroupCount.style.animation = 'pulse 0.3s ease-out';
            setTimeout(() => {
                muscleGroupCount.style.animation = '';
            }, 300);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            muscleGroupCount.textContent = muscleGroupData[this.value];
        });
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    const sessionsLimit = document.getElementById('sessions-limit');
    const sessionsSort = document.getElementById('sessions-sort');
    const sessionsContainer = document.getElementById('sessions-container');

    if (sessionsLimit && sessionsSort && sessionsContainer) {
        let currentSessions = Array.from(sessionsContainer.querySelectorAll('.workout-session'));

        function updateSessionsDisplay() {
            const limit = sessionsLimit.value === 'all' ? currentSessions.length : parseInt(sessionsLimit.value);
            const sortBy = sessionsSort.value;

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            currentSessions.sort((a, b) => {
                switch (sortBy) {
                    case 'date-desc':
                        return new Date(b.dataset.date) - new Date(a.dataset.date);
                    case 'date-asc':
                        return new Date(a.dataset.date) - new Date(b.dataset.date);
                    case 'calories-desc':
                        return parseFloat(b.dataset.calories) - parseFloat(a.dataset.calories);
                    case 'calories-asc':
                        return parseFloat(a.dataset.calories) - parseFloat(b.dataset.calories);
                    case 'duration-desc':
                        return parseFloat(b.dataset.duration) - parseFloat(a.dataset.duration);
                    case 'duration-asc':
                        return parseFloat(a.dataset.duration) - parseFloat(b.dataset.duration);
                    default:
                        return 0;
                }
            });

            // –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            sessionsContainer.innerHTML = '';

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            currentSessions.slice(0, limit).forEach((session, index) => {
                setTimeout(() => {
                    sessionsContainer.appendChild(session);
                    session.style.animation = 'slideInUp 0.5s ease-out';
                }, index * 100);
            });

            // –ï—Å–ª–∏ –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
            if (currentSessions.length === 0) {
                sessionsContainer.innerHTML = '<p class="no-data">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. <a href="{{ url_for("add_workout_session") }}">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!</a></p>';
            }
        }

        sessionsLimit.addEventListener('change', updateSessionsDisplay);
        sessionsSort.addEventListener('change', updateSessionsDisplay);
    }
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showStreakNotification() {
    const notification = document.getElementById('streak-notification');
    if (notification) {
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateY(0)';
        }, 10);
    }
}

function hideStreakNotification() {
    const notification = document.getElementById('streak-notification');
    if (notification) {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 300);
    }
}

// –ê–Ω–∏–º–∞—Ü–∏–∏
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .stat-card {
        position: relative;
        text-align: center;
        padding: 1.5rem 1rem;
        display: flex;
        flex-direction: column;
        min-height: 160px;
    }

    .stat-card h3 {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
        line-height: 1.3;
        min-height: 2.5rem;
        max-height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 0.25rem;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0.5rem 0;
        line-height: 1;
        min-height: 3rem;
        max-height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 3rem;
    }
    
    /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ü–∏—Ñ—Ä –Ω–∞ –æ–¥–Ω–æ–º —É—Ä–æ–≤–Ω–µ */
    .stats-grid {
        align-items: stretch;
    }
    
    .stat-card .stat-label {
        flex: 0 0 auto;
        margin-top: 0.5rem;
    }
    
    /* –î–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã –º—ã—à—Ü */
    .muscle-group-card {
        display: flex;
        flex-direction: column;
    }
    
    .muscle-group-card h3 {
        min-height: 2.5rem;
        max-height: 2.5rem;
    }
    
    .muscle-group-card .stat-number {
        min-height: 3rem;
        max-height: 3rem;
        flex: 0 0 3rem;
    }
    
    .muscle-group-select {
        margin-top: 0.75rem;
        flex: 0 0 auto;
    }
    
    /* –î–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —Ü–µ–ø–æ—á–∫–æ–π */
    .streak-card .stat-number {
        min-height: 3rem;
        max-height: 3rem;
        flex: 0 0 3rem;
    }
    
    .streak-info {
        flex: 0 0 auto;
        margin-top: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
    }

    .streak-card {
        cursor: help;
    }

    .notification-card {
        position: relative;
        background: linear-gradient(135deg, #1e293b, #334155);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1rem 0;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100;
    }

    .notification-content {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        position: relative;
    }

    .notification-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
        margin-top: 0.2rem;
    }

    .notification-text {
        flex: 1;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .notification-text strong {
        color: #fbbf24;
        margin-bottom: 0.5rem;
        display: block;
    }

    .notification-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s ease;
    }

    .notification-close:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .muscle-group-select {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.5rem 0.75rem;
        background: white;
        font-size: 0.85rem;
        font-weight: 600;
        color: #374151;
        cursor: pointer;
        transition: all 0.3s ease;
        outline: none;
        width: 100%;
        text-align: center;
        margin-top: 0.75rem;
        min-height: var(--touch-target-min);
    }
    
    .muscle-group-card {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .muscle-group-card h3 {
        margin-bottom: 0.5rem;
    }
    
    .muscle-group-card .stat-number {
        margin: 0.5rem 0;
    }

    .muscle-group-select:hover {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .muscle-group-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .sessions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .sessions-controls {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .control-group label {
        font-weight: 500;
        color: var(--text-secondary);
        white-space: nowrap;
    }

    .control-select {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 6px 12px;
        background: white;
        font-size: 0.9rem;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.3s ease;
        outline: none;
        min-width: 140px;
    }

    .control-select:hover {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .control-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .workout-session {
        animation: slideInUp 0.5s ease-out;
    }

    @media (max-width: 768px) {
        .sessions-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .sessions-controls {
            justify-content: space-between;
        }
        
        .control-group {
            flex: 1;
            justify-content: space-between;
        }
        
        .control-select {
            min-width: 120px;
        }
        
        .stat-card {
            min-height: 140px;
        }
        
        .stat-card h3 {
            font-size: 0.8rem;
            min-height: 2.5rem;
            max-height: 2.5rem;
        }
        
        .stat-number {
            font-size: 2rem;
            min-height: 2.5rem;
            max-height: 2.5rem;
            flex: 0 0 2.5rem;
        }
        
        .muscle-group-card .stat-number {
            min-height: 2.5rem;
            max-height: 2.5rem;
            flex: 0 0 2.5rem;
        }
        
        .streak-card .stat-number {
            min-height: 2.5rem;
            max-height: 2.5rem;
            flex: 0 0 2.5rem;
        }
        
        .notification-card {
            margin: 0.5rem 0;
            padding: 1rem;
        }
        
        .notification-content {
            gap: 0.75rem;
        }
        
        .notification-text {
            font-size: 0.85rem;
        }
    }

    @media (max-width: 480px) {
        .sessions-controls {
            flex-direction: column;
            gap: 1rem;
        }
        
        .control-group {
            justify-content: space-between;
        }
        
        .muscle-group-select {
            min-width: 80px;
            font-size: 0.8rem;
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}